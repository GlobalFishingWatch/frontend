steps:
  - name: 'gcr.io/$PROJECT_ID/restore_cache'
    id: restore_cache
    waitFor: ['-']
    script: |
      #!/usr/bin/env bash
      restore_cache --bucket=gs://frontend-cache-dependencies --key=yarn-$( checksum yarn.lock ) --key_fallback=yarn3-cache

  - id: 'install-yarn'
    waitFor: ['restore_cache']
    name: node:18-alpine
    script: |
      if [ ! -d "node_modules" ]; then
        apk add git
        yarn set version 3.3.1
        yarn -v
        yarn install --immutable
      fi

  - id: 'test'
    waitFor: ['install-yarn']
    name: node:18
    entrypoint: yarn
    args: ['nx', 'test', 'vessel-history']

timeout: 600s
