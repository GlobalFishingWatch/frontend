steps:
  - name: 'gcr.io/$PROJECT_ID/restore_cache'
    id: restore_cache
    waitFor: ['-']
    script: |
      #!/usr/bin/env bash
      restore_cache --bucket=gs://frontend-cache-dependencies --key=yarn-$( checksum yarn.lock ) --key_fallback=yarn3-cache

  - id: 'install-yarn'
    waitFor: ['restore_cache']
    name: node:18
    script: |
      if [ ! -d "node_modules" ]; then
        apk add git
        yarn set version 4.1.1
        yarn -v
        yarn install --immutable
      fi

  - id: 'save_cache'
    waitFor: ['install-yarn']
    name: 'gcr.io/$PROJECT_ID/restore_cache'
    env:
      - 'BRANCH_NAME=$BRANCH_NAME'
    script: |
      #!/usr/bin/env bash
      save_cache --bucket=gs://frontend-cache-dependencies --key=yarn-$( checksum yarn.lock ) --path=./node_modules --no-clobber
      if [ -d ".yarn/cache" ]; then
        if [ $BRANCH_NAME == "dev" ]; then
          save_cache --bucket=gs://frontend-cache-dependencies --key=yarn3-cache --path=./.yarn/cache
        fi
      fi

  - id: 'setup auth to npmjs'
    waitFor: ['install-yarn']
    name: node:18
    args:
      - '-c'
      - |
        echo "//registry.npmjs.org/:_authToken=$$NODE_AUTH_TOKEN" > .npmrc
    entrypoint: bash
    secretEnv:
      - NODE_AUTH_TOKEN

  - id: 'i18n-labels publish stable'
    waitFor: ['setup auth to npmjs']
    name: node:18
    env:
      - 'NX_CLOUD_AUTH_TOKEN=$_NX_CLOUD_AUTH_TOKEN'
    entrypoint: npx
    args: ['nx', 'publish:stable', 'i18n-labels']

  - id: 'i18n-labels purge stable'
    waitFor: ['i18n-labels publish stable']
    name: node:18
    env:
      - 'NX_CLOUD_AUTH_TOKEN=$_NX_CLOUD_AUTH_TOKEN'
    entrypoint: npx
    args: ['nx', 'purge:stable', 'i18n-labels']

availableSecrets:
  secretManager:
    - versionName: projects/$PROJECT_ID/secrets/NPM_TOKEN/versions/latest
      env: NODE_AUTH_TOKEN

timeout: 1800s
