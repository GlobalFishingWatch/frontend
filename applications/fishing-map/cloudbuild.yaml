steps:
  - id: 'download-cached-yarn-dependencies'
    name: gcr.io/cloud-builders/gsutil
    entrypoint: bash
    args:
      - '-c'
      - |
        gsutil cp gs://frontend-cache-dependencies/cache/yarn-dependencies.tgz yarn-dependencies.tgz || exit 0
        tar -zxf yarn-dependencies.tgz || exit 0

  - id: 'install-yarn'
    name: node:14
    entrypoint: yarn
    args: ['install']

  - id: 'check-deps'
    name: node:14
    entrypoint: yarn
    args: ['why', 'tslib']

  - id: 'upload-cached-yarn-dependencies'
    waitFor: ['install-yarn']
    name: gcr.io/cloud-builders/gsutil
    entrypoint: bash
    args:
      - '-c'
      - |
        tar -zcf yarn-dependencies.tgz ./node_modules
        gsutil cp yarn-dependencies.tgz gs://frontend-cache-dependencies/cache/yarn-dependencies.tgz

  - id: 'build-app'
    waitFor: ['install-yarn']
    name: node:14
    entrypoint: yarn
    args: ['nx', 'deploy', 'fishing-map', '--skip-nx-cache']
    env:
      - 'REACT_APP_API_GATEWAY=$_REACT_APP_API_GATEWAY'
      - 'REACT_APP_CARRIER_PORTAL_URL_=$_REACT_APP_CARRIER_PORTAL_URL_'
      - 'REACT_APP_FEEDBACK_SPREADSHEET_ID=$_REACT_APP_FEEDBACK_SPREADSHEET_ID'
      - 'REACT_APP_GOOGLE_MEASUREMENT_ID=$_REACT_APP_GOOGLE_MEASUREMENT_ID'
      - 'REACT_APP_GOOGLE_TAG_MANAGER_KEY=$_REACT_APP_GOOGLE_TAG_MANAGER_KEY'
      - 'REACT_APP_GOOGLE_UNIVERSAL_ANALYTICS_ID=$_REACT_APP_GOOGLE_UNIVERSAL_ANALYTICS_ID'
      - 'REACT_APP_LATEST_CARRIER_DATASET_ID=$_REACT_APP_LATEST_CARRIER_DATASET_ID'
      - 'REACT_APP_SPREADSHEET_CLIENT_EMAIL=$_REACT_APP_SPREADSHEET_CLIENT_EMAIL'
      - 'REACT_APP_SPREADSHEET_PRIVATE_KEY=$_REACT_APP_SPREADSHEET_PRIVATE_KEY'
      - 'REACT_APP_USE_PRESENCE_POC=$_REACT_APP_USE_PRESENCE_POC'
      - 'REACT_APP_WORKSPACE_ENV=$_REACT_APP_WORKSPACE_ENV'
      - 'REACT_APP_WORKSPACES_SPREADSHEET_ID=$_REACT_APP_WORKSPACES_SPREADSHEET_ID'
      - 'SKIP_PREFLIGHT_CHECK=true'

  - name: 'gcr.io/kaniko-project/executor:v1.6.0'
    id: 'build-image'
    waitFor: ['build-app']
    args:
      [
        '--destination=gcr.io/world-fishing-827/github.com/globalfishingwatch/fishing-map:$COMMIT_SHA',
        '--cache=true',
        '--build-arg',
        'BASIC_AUTH_USER=$_BASIC_AUTH_USER',
        '--build-arg',
        'BASIC_AUTH_PASS=$_BASIC_AUTH_PASS',
        '--target',
        'production',
        '-f',
        './applications/fishing-map/Dockerfile',
        '-c',
        './dist/applications/fishing-map',
      ]

  # Deploy to the appropriate environment
  - name: 'gcr.io/cloud-builders/gcloud'
    waitFor: ['build-image']
    id: 'deploy-cloud-run'
    args:
      [
        'beta',
        'run',
        'deploy',
        '$_RUN_SERVICE_NAME',
        '--project',
        '$_RUN_PROJECT',
        '--image',
        'gcr.io/world-fishing-827/github.com/globalfishingwatch/fishing-map:$COMMIT_SHA',
        '--region',
        '$_RUN_REGION',
        '--platform',
        'managed',
        '--set-env-vars',
        'BASIC_AUTH=$_BASIC_AUTH',
        '--allow-unauthenticated',
      ]

timeout: 1800s
